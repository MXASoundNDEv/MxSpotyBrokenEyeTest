<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a1a">
    <title>Spotify Blind Test Mobile</title>
    <link rel="stylesheet" href="/styles/mobile.css">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    
    <!-- Desktop fallback link -->
    <script>
        // Lien vers version desktop si souhait√©
        window.switchToDesktop = () => {
            window.location.href = '/desktop';
        };
        
        // Fonction globale requise par Spotify SDK
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('üéµ Spotify Web Playback SDK Ready');
            if (window.initializeSpotify) {
                window.initializeSpotify();
            }
        };
    </script>
</head>
<body>
    <!-- Aurora Background Effects -->
    <div class="aurora-bg">
        <div class="aurora-wave"></div>
        <div class="aurora-wave"></div>
        <div class="aurora-wave"></div>
    </div>

    <!-- Header fixe avec compte Spotify et options -->
    <header class="mobile-header">
        <div class="spotify-account">
            <img id="mobilePlayerAvatar" src="https://i.scdn.co/image/ab6775700000ee850afe9be4724435a51d4644f8" alt="Spotify Account" class="account-avatar" />
            <div class="account-status">
                <div id="mobilePlayerName" class="account-name">Connexion...</div>
                <div class="account-indicator" id="accountIndicator">ÔøΩ</div>
            </div>
        </div>
        
        <button id="mobileOptionsBtn" class="options-button">
            <span class="options-icon">‚öôÔ∏è</span>
        </button>
    </header>

    <!-- Section historique -->
    <section class="history-section">
        <div class="history-header">
            <h3>üìö Historique</h3>
            <div class="history-stats">
                <span class="stat-discovered" id="mobileDiscoveredCount">0</span>/<span class="stat-total" id="mobileTotalCount">0</span>
            </div>
        </div>
        <div class="history-grid" id="mobileHistoryGrid">
            <!-- L'historique sera g√©n√©r√© dynamiquement -->
        </div>
    </section>

    <!-- Section principale avec thumbnail -->
    <main class="main-section">
        <div class="thumbnail-container" id="mobileThumbnailContainer">
            <div class="thumbnail-glow"></div>
            <img id="mobileThumbnail" src="https://i.scdn.co/image/ab67616d00001e029c11e6241d59940a0157c75a" alt="Album Cover" class="thumbnail" />
            <div class="thumbnail-overlay">
                <div class="mystery-indicator">
                    <span class="mystery-icon">üé≠</span>
                    <span class="mystery-text">Myst√®re</span>
                </div>
            </div>
            <div class="autoswipe-pulse" id="autoswipePulse"></div>
        </div>
        
        <!-- Informations de la chanson -->
        <div class="song-info">
            <div id="mobileSongTitle" class="song-title">üéµ Chanson myst√®re</div>
            <div id="mobileSongArtist" class="song-artist">üé§ Artiste myst√®re</div>
        </div>
    </main>

    <!-- Input fixe en bas -->
    <footer class="input-footer">
        <div class="input-container">
            <!-- Barre de progression lin√©aire simple -->
            <div class="autoswipe-linear-progress" id="autoswipeLinearProgress"></div>
            
            <!-- Indicateur textuel de progression -->
            <div class="autoswipe-progress-text" id="autoswipeProgressText" style="display: none;">0%</div>
            
            <!-- Barre de progression autoswipe autour de l'input -->
            <div class="autoswipe-ring" id="autoswipeRing">
                <div class="autoswipe-progress" id="autoswipeProgress"></div>
            </div>
            
            <div class="input-wrapper">
                <input id="mobileSongName" type="text" placeholder="üéØ Tape ta r√©ponse ici..." maxlength="100" autocomplete="off" spellcheck="false" class="song-input" />
                <div class="input-glow"></div>
            </div>
            
            <!-- Temps restant autoswipe -->
            <div class="autoswipe-timer" id="autoswipeTimer" style="display: none;">
                <span id="autoswipeTimeRemaining">10s</span>
            </div>
        </div>
    </footer>

    <!-- Modal Options -->
    <div id="optionsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Options</h3>
                <button id="closeModal" class="close-button">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="option-item" id="loginBtn" style="display: none;">
                    <span class="option-icon">üîë</span>
                    <span class="option-text">Se connecter √† Spotify</span>
                </div>
                
                <div class="option-item" id="PlaylistDivBtn">
                    <span class="option-icon">üéµ</span>
                    <span class="option-text">Playlist</span>
                </div>
                
                <div class="option-item" id="PlayerDivBtn">
                    <span class="option-icon">üéß</span>
                    <span class="option-text">Lecteur</span>
                </div>
                
                <div class="option-item" id="OptionsDivBtn">
                    <span class="option-icon">‚öôÔ∏è</span>
                    <span class="option-text">Param√®tres</span>
                </div>
                
                <div class="option-item autoswipe-toggle" id="autoswipe">
                    <span class="option-icon">ü§ñ</span>
                    <span class="option-text">AutoSwipe</span>
                    <span id="autoswipeStatus" class="autoswipe-status">‚è∏Ô∏è</span>
                </div>
                
                <div class="option-item" onclick="switchToDesktop()">
                    <span class="option-icon">üñ•Ô∏è</span>
                    <span class="option-text">Version Desktop</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Connexion Spotify...</div>
    </div>

    <!-- Scripts - dans l'ordre d'importance -->
    <script src="/scripts/Popup.js"></script>
    <script src="/scripts/SpotifyV2.js"></script>
    <script src="/scripts/game.js"></script>
    <script src="/scripts/mobile.js"></script>
    
    <!-- Chargement des scripts existants si n√©cessaire -->
    <script>
        // R√©cup√©ration du token depuis l'URL (apr√®s OAuth)
        function getTokenFromURL() {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            return {
                access_token: hashParams.get('access_token'),
                refresh_token: hashParams.get('refresh_token')
            };
        }
        
        // Fonction pour initialiser le mobile apr√®s le chargement du syst√®me principal
        function initializeMobileInterface() {
            console.log('üéØ Initialisation interface mobile...');
            
            // Utiliser la nouvelle fonction globale pour r√©cup√©rer le token
            let token = null;
            if (window.getSpotifyToken) {
                token = window.getSpotifyToken();
            } else {
                // Fallback vers l'ancienne m√©thode
                const tokens = getTokenFromURL();
                const storedToken = localStorage.getItem('access_token') || localStorage.getItem('spotify_access_token');
                token = tokens.access_token || storedToken;
            }
            
            if (token) {
                console.log('üîê Token trouv√©, initialisation Spotify...');
                
                // Nettoyer l'URL si n√©cessaire
                if (window.location.hash.includes('access_token')) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // Mettre √† jour le token dans le syst√®me Spotify
                if (window.updateSpotifyToken) {
                    window.updateSpotifyToken(token);
                } else {
                    // Fallback pour ancienne m√©thode
                    localStorage.setItem('access_token', token);
                    localStorage.setItem('spotify_access_token', token);
                    if (window.appState) {
                        window.appState.token = token;
                    }
                }
                
                // Initialiser Spotify
                if (window.initializeSpotify) {
                    window.initializeSpotify();
                } else if (window.initUI) {
                    window.initUI();
                } else if (window.initPlayer) {
                    window.initPlayer();
                } else {
                    console.log('‚ö†Ô∏è Aucune fonction d\'initialisation trouv√©e');
                }
                
            } else {
                // Pas de token - afficher le bouton de connexion
                console.log('‚ùå Aucun token Spotify trouv√©');
                document.getElementById('loginBtn').style.display = 'flex';
                
                // Mettre √† jour l'interface
                const indicator = document.getElementById('accountIndicator');
                if (indicator) {
                    indicator.textContent = 'üî¥';
                }
                
                const playerName = document.getElementById('mobilePlayerName');
                if (playerName) {
                    playerName.textContent = 'Non connect√©';
                }
            }
        }
        
        // Fonction globale pour initialiser l'app (cr√©√©e sp√©cialement pour mobile)
        window.initApp = function(token) {
            console.log('üöÄ initApp appel√© avec token:', token ? 'pr√©sent' : 'absent');
            
            if (token) {
                localStorage.setItem('access_token', token);
                if (window.appState) {
                    window.appState.token = token;
                }
            }
            
            // Appeler l'initialisation principale
            if (window.initUI) {
                window.initUI();
            } else if (window.initPlayer) {
                window.initPlayer();
            } else {
                console.error('‚ùå Aucune fonction d\'initialisation trouv√©e');
            }
        };
        
        // Gestion du bouton de connexion
        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    window.location.href = '/login';
                });
            }
        });
    </script>
    
    <!-- Script d'initialisation mobile uniquement -->
    <script>
        // Fonction de test SIMPLE pour la barre de progression
        window.testProgressBar = function() {
            console.log('üß™ Test de la barre de progression...');
            
            const linearProgress = document.getElementById('autoswipeLinearProgress');
            const progressText = document.getElementById('autoswipeProgressText');
            
            if (!linearProgress) {
                console.error('‚ùå Barre de progression non trouv√©e !');
                return;
            }
            
            // Afficher l'indicateur textuel
            if (progressText) {
                progressText.style.display = 'block';
            }
            
            // Test de progression de 0 √† 100%
            let progress = 0;
            const testInterval = setInterval(() => {
                progress += 5;
                
                // Mettre √† jour la variable CSS
                linearProgress.style.setProperty('--progress-width', `${progress}%`);
                
                // Mettre √† jour le texte
                if (progressText) {
                    progressText.textContent = `${progress}%`;
                }
                
                console.log(`üìä Progression: ${progress}%`);
                
                if (progress >= 100) {
                    clearInterval(testInterval);
                    console.log('‚úÖ Test termin√© !');
                    
                    // Reset apr√®s 2 secondes
                    setTimeout(() => {
                        linearProgress.style.setProperty('--progress-width', '0%');
                        if (progressText) {
                            progressText.style.display = 'none';
                            progressText.textContent = '0%';
                        }
                    }, 2000);
                }
            }, 200);
        };
        
        // Test automatique au chargement
        setTimeout(() => {
            console.log('üéØ Page charg√©e - utiliser testProgressBar() pour tester');
            // Afficher automatiquement une progression √† 30% pour voir la barre
            const linearProgress = document.getElementById('autoswipeLinearProgress');
            if (linearProgress) {
                linearProgress.style.setProperty('--progress-width', '30%');
                console.log('üìä Barre de progression visible √† 30%');
            }
        }, 1000);
        
        // Chargement des scripts requis de fa√ßon asynchrone pour √©viter les doublons
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                // V√©rifier si le script est d√©j√† charg√©
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
        
        // Charger les scripts dans l'ordre
        Promise.all([
            loadScript('/scripts/SpotifyV2.js'),
            loadScript('/scripts/game.js'),
            loadScript('/scripts/mobile.js')
        ]).then(() => {
            console.log('üéØ Tous les scripts mobile charg√©s');
            
            // Initialiser la compatibilit√© mobile d'abord
            if (typeof initMobileCompatibility === 'function') {
                initMobileCompatibility();
            }
            
            // Puis initialiser l'interface mobile
            if (typeof initializeMobileInterface === 'function') {
                initializeMobileInterface();
            }
        }).catch(err => {
            console.error('‚ùå Erreur chargement scripts:', err);
        });
    </script>
</body>
</html>
