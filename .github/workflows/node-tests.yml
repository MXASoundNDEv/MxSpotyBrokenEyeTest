name: ðŸ§ª Tests API Blindtest

on:
  push:
    branches: [ main, Mobile, develop, RunTest ]
  pull_request:
    branches: [ main, Mobile ]

jobs:
  # ðŸš€ Tests sans token (toujours exÃ©cutÃ©s)
  tests-sans-token:
    name: ðŸ“± Tests Statiques + SÃ©curitÃ©
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Installation des dÃ©pendances
      run: npm ci

    - name: ðŸ§ª Tests sans token requis
      run: node tests/test-runner-basic.js
      env:
        NODE_ENV: test
        SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID || 'test_client_id' }}
        SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET || 'test_client_secret' }}
        SPOTIFY_REDIRECT_URI: http://127.0.0.1:3000/callback
        PORT: 3000

  # ðŸ” Tests avec token (si secrets disponibles)
  tests-avec-token:
    name: ðŸ”‘ Tests API Spotify Complets
    runs-on: ubuntu-latest
    needs: tests-sans-token

    steps:
    - name: ðŸ“¥ Checkout du code  
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Installation des dÃ©pendances
      run: npm ci

    - name: ðŸš€ DÃ©marrage serveur de test
      run: |
        npm run start &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Attente du dÃ©marrage du serveur
        echo "â³ Attente dÃ©marrage serveur..."
        for i in {1..30}; do
          if curl -s http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Serveur dÃ©marrÃ©"
            break
          fi
          sleep 1
        done
      env:
        SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID || 'test_client_id' }}
        SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET || 'test_client_secret' }}
        SPOTIFY_REDIRECT_URI: http://localhost:3000/callback
        PORT: 3000
        NODE_ENV: test

    - name: ðŸ§ª Tests API complets
      run: npm test
      env:
        SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID || 'test_client_id' }}
        SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET || 'test_client_secret' }}
        SPOTIFY_REDIRECT_URI: http://localhost:3000/callback
        SPOTIFY_TEST_TOKEN: invalid_test_token
        PORT: 3000
        NODE_ENV: test

    - name: ðŸ›‘ ArrÃªt du serveur
      if: always()
      run: |
        if [ -n "$SERVER_PID" ]; then
          kill $SERVER_PID 2>/dev/null || true
        fi
