name: 🧪 Tests Complets BlindTest

on:
  push:
    branches: [ main, Mobile, develop, RunTest ]
  pull_request:
    branches: [ main, Mobile ]

jobs:
  # 🚀 Tests de base (toujours exécutés)
  tests-base:
    name: � Tests Métriques + API Base
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout du code
      uses: actions/checkout@v4

    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: 📦 Installation des dépendances
      run: npm ci

    - name: 🧪 Tests métriques Prometheus
      run: npm run test:metrics-only
      env:
        NODE_ENV: test

    - name: 🧪 Tests API de base
      run: npm run test:basic
      env:
        NODE_ENV: test
        SPOTIFY_CLIENT_ID: 'test_client_id'
        SPOTIFY_CLIENT_SECRET: 'test_client_secret'
        SPOTIFY_REDIRECT_URI: http://127.0.0.1:3000/callback
        PORT: 3000

    - name: 📋 Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-base
        path: tests/test-results.json

  # 🔐 Tests complets avec token Spotify (si disponible)
  tests-complets:
    name: 🔑 Tests API Spotify Complets
    runs-on: ubuntu-latest
    needs: tests-base
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: 📥 Checkout du code  
      uses: actions/checkout@v4

    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: 📦 Installation des dépendances
      run: npm ci

    - name: 🚀 Tests complets avec serveur
      run: |
        npm run start &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Attente du démarrage
        for i in {1..30}; do
          if curl -s http://localhost:3000 >/dev/null 2>&1; then
            echo "✅ Serveur démarré"
            break
          fi
          sleep 1
        done
        
        # Tests complets
        npm run test:complete
        
        # Arrêt du serveur
        kill $SERVER_PID 2>/dev/null || true
      env:
        SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
        SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
        SPOTIFY_REDIRECT_URI: http://localhost:3000/callback
        PORT: 3000
        NODE_ENV: test

    - name: � Upload test results complets
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-complete
        path: tests/test-results.json
