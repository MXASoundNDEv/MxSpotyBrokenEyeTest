name: ðŸ§ª Tests Complets BlindTest

on:
  push:
    branches: [ main, Mobile, develop, RunTest ]
  pull_request:
    branches: [ main, Mobile ]

jobs:
  # ðŸš€ Tests de base (toujours exÃ©cutÃ©s)
  tests-base:
    name: ï¿½ Tests MÃ©triques + API Base
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Installation des dÃ©pendances
      run: npm ci

    - name: ðŸ§ª Tests mÃ©triques Prometheus
      run: npm run test:metrics-only
      env:
        NODE_ENV: test

    - name: ðŸ§ª Tests API de base
      run: npm run test:basic
      env:
        NODE_ENV: test
        SPOTIFY_CLIENT_ID: 'test_client_id'
        SPOTIFY_CLIENT_SECRET: 'test_client_secret'
        SPOTIFY_REDIRECT_URI: http://127.0.0.1:3000/callback
        PORT: 3000

    - name: ðŸ“‹ Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-base
        path: tests/test-results.json

  # ðŸ” Tests complets avec token Spotify (si disponible)
  tests-complets:
    name: ðŸ”‘ Tests API Spotify Complets
    runs-on: ubuntu-latest
    needs: tests-base
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ðŸ“¥ Checkout du code  
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Installation des dÃ©pendances
      run: npm ci

    - name: ðŸš€ Tests complets avec serveur
      run: |
        npm run start &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Attente du dÃ©marrage
        for i in {1..30}; do
          if curl -s http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Serveur dÃ©marrÃ©"
            break
          fi
          sleep 1
        done
        
        # Tests complets
        npm run test:complete
        
        # ArrÃªt du serveur
        kill $SERVER_PID 2>/dev/null || true
      env:
        SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
        SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
        SPOTIFY_REDIRECT_URI: http://localhost:3000/callback
        PORT: 3000
        NODE_ENV: test

    - name: ï¿½ Upload test results complets
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-complete
        path: tests/test-results.json
